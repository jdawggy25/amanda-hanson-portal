---
import { getCollection } from 'astro:content';
import DocLayout from '../../layouts/DocLayout.astro';
import clientsConfig from '../../../clients.config.json';

export const prerender = true;

export async function getStaticPaths() {
  // Get clients from config file
  const CLIENTS = clientsConfig.clients.filter(c => c.enabled).map(c => c.id);

  const docs = await getCollection('docs');

  return docs.map((doc) => {
    // Extract client from slug (e.g., "v3/getting-started" -> "v3")
    const parts = doc.slug.split('/');
    const client = parts[0];

    // Only include if it's a valid client
    if (!CLIENTS.includes(client)) {
      return null;
    }

    // Remove client prefix from slug for the URL
    const slug = parts.slice(1).join('/');

    // Skip sprint-tracker - handled by dedicated SSR page
    if (slug === 'dev/sprint-tracker') {
      return null;
    }

    return {
      params: {
        client,
        slug
      },
      props: { doc },
    };
  }).filter(Boolean);
}

const { doc } = Astro.props;
const { client } = Astro.params;
const { Content, headings } = await doc.render();

// Extract title from first h1 heading or format from slug
function formatTitle(slug: string): string {
  return slug
    .replace(/_/g, ' ')
    .replace(/-/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

const title = doc.data.title
  || headings.find(h => h.depth === 1)?.text
  || formatTitle(doc.slug);
---

<DocLayout title={title} client={client}>
  <Content />
</DocLayout>

