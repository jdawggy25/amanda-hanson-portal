---
import type { TransformedTask } from '../lib/jira/types';

interface Props {
  tasks: TransformedTask[];
  projectName?: string;
}

const { tasks, projectName = 'Project' } = Astro.props;

const todoTasks = tasks.filter(t => t.status === 'todo');
const inProgressTasks = tasks.filter(t => t.status === 'in-progress');
const doneTasks = tasks.filter(t => t.status === 'done');

function getPriorityClass(priority: string): string {
  const p = priority.toLowerCase();
  if (p === 'highest' || p === 'high') return 'priority-high';
  if (p === 'medium') return 'priority-medium';
  return 'priority-low';
}

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
---

<div class="kanban-board">
  <div class="kanban-header">
    <h3>{projectName} Sprint Board</h3>
    <span class="task-count">{tasks.length} tasks</span>
  </div>

  <div class="kanban-columns">
    <!-- TO DO Column -->
    <div class="kanban-column column-todo">
      <div class="column-header">
        <span class="column-title">To Do</span>
        <span class="column-count">{todoTasks.length}</span>
      </div>
      <div class="column-cards">
        {todoTasks.length === 0 ? (
          <div class="empty-column">No tasks</div>
        ) : (
          todoTasks.map((task) => (
            <div class="task-card" data-task-id={task.key}>
              <div class="card-header">
                <span class="task-key">{task.key}</span>
                <span class={`priority-dot ${getPriorityClass(task.priority)}`} title={task.priority}></span>
              </div>
              <div class="task-title">{task.summary}</div>
              <div class="card-footer">
                <span class="issue-type">{task.issueType}</span>
                {task.assignee ? (
                  <span class="assignee">{task.assignee}</span>
                ) : (
                  <span class="unassigned">Unassigned</span>
                )}
              </div>
              <!-- Expanded Details (hidden by default) -->
              <div class="task-details" data-details-for={task.key}>
                <div class="details-section">
                  <div class="details-header">
                    <span class="details-key">{task.key}</span>
                    <a href={task.jiraUrl} target="_blank" rel="noopener noreferrer" class="jira-link">
                      Open in Jira
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                      </svg>
                    </a>
                  </div>
                  <h4 class="details-title">{task.summary}</h4>
                  {task.description && (
                    <div class="details-description">
                      <span class="details-label">Description</span>
                      <p>{task.description}</p>
                    </div>
                  )}
                  <div class="details-meta">
                    <div class="meta-item">
                      <span class="meta-label">Status</span>
                      <span class="meta-value status-badge status-todo">{task.statusLabel}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Priority</span>
                      <span class={`meta-value priority-badge ${getPriorityClass(task.priority)}`}>{task.priority}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Type</span>
                      <span class="meta-value">{task.issueType}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Assignee</span>
                      <span class="meta-value">{task.assignee || 'Unassigned'}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Created</span>
                      <span class="meta-value">{formatDate(task.created)}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Updated</span>
                      <span class="meta-value">{formatDate(task.updated)}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>

    <!-- IN PROGRESS Column -->
    <div class="kanban-column column-in-progress">
      <div class="column-header">
        <span class="column-title">In Progress</span>
        <span class="column-count">{inProgressTasks.length}</span>
      </div>
      <div class="column-cards">
        {inProgressTasks.length === 0 ? (
          <div class="empty-column">No tasks</div>
        ) : (
          inProgressTasks.map((task) => (
            <div class="task-card" data-task-id={task.key}>
              <div class="card-header">
                <span class="task-key">{task.key}</span>
                <span class={`priority-dot ${getPriorityClass(task.priority)}`} title={task.priority}></span>
              </div>
              <div class="task-title">{task.summary}</div>
              <div class="card-footer">
                <span class="issue-type">{task.issueType}</span>
                {task.assignee ? (
                  <span class="assignee">{task.assignee}</span>
                ) : (
                  <span class="unassigned">Unassigned</span>
                )}
              </div>
              <!-- Expanded Details -->
              <div class="task-details" data-details-for={task.key}>
                <div class="details-section">
                  <div class="details-header">
                    <span class="details-key">{task.key}</span>
                    <a href={task.jiraUrl} target="_blank" rel="noopener noreferrer" class="jira-link">
                      Open in Jira
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                      </svg>
                    </a>
                  </div>
                  <h4 class="details-title">{task.summary}</h4>
                  {task.description && (
                    <div class="details-description">
                      <span class="details-label">Description</span>
                      <p>{task.description}</p>
                    </div>
                  )}
                  <div class="details-meta">
                    <div class="meta-item">
                      <span class="meta-label">Status</span>
                      <span class="meta-value status-badge status-in-progress">{task.statusLabel}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Priority</span>
                      <span class={`meta-value priority-badge ${getPriorityClass(task.priority)}`}>{task.priority}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Type</span>
                      <span class="meta-value">{task.issueType}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Assignee</span>
                      <span class="meta-value">{task.assignee || 'Unassigned'}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Created</span>
                      <span class="meta-value">{formatDate(task.created)}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Updated</span>
                      <span class="meta-value">{formatDate(task.updated)}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>

    <!-- DONE Column -->
    <div class="kanban-column column-done">
      <div class="column-header">
        <span class="column-title">Done</span>
        <span class="column-count">{doneTasks.length}</span>
      </div>
      <div class="column-cards">
        {doneTasks.length === 0 ? (
          <div class="empty-column">No tasks</div>
        ) : (
          doneTasks.map((task) => (
            <div class="task-card card-done" data-task-id={task.key}>
              <div class="card-header">
                <span class="task-key">{task.key}</span>
                <span class={`priority-dot ${getPriorityClass(task.priority)}`} title={task.priority}></span>
              </div>
              <div class="task-title">{task.summary}</div>
              <div class="card-footer">
                <span class="issue-type">{task.issueType}</span>
                {task.assignee ? (
                  <span class="assignee">{task.assignee}</span>
                ) : (
                  <span class="unassigned">Unassigned</span>
                )}
              </div>
              <!-- Expanded Details -->
              <div class="task-details" data-details-for={task.key}>
                <div class="details-section">
                  <div class="details-header">
                    <span class="details-key">{task.key}</span>
                    <a href={task.jiraUrl} target="_blank" rel="noopener noreferrer" class="jira-link">
                      Open in Jira
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                      </svg>
                    </a>
                  </div>
                  <h4 class="details-title">{task.summary}</h4>
                  {task.description && (
                    <div class="details-description">
                      <span class="details-label">Description</span>
                      <p>{task.description}</p>
                    </div>
                  )}
                  <div class="details-meta">
                    <div class="meta-item">
                      <span class="meta-label">Status</span>
                      <span class="meta-value status-badge status-done">{task.statusLabel}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Priority</span>
                      <span class={`meta-value priority-badge ${getPriorityClass(task.priority)}`}>{task.priority}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Type</span>
                      <span class="meta-value">{task.issueType}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Assignee</span>
                      <span class="meta-value">{task.assignee || 'Unassigned'}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Created</span>
                      <span class="meta-value">{formatDate(task.created)}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Updated</span>
                      <span class="meta-value">{formatDate(task.updated)}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  </div>
</div>

<style>
  .kanban-board {
    margin: var(--space-6) 0;
  }

  .kanban-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .kanban-header h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
  }

  .task-count {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .kanban-columns {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
    min-height: 400px;
  }

  .kanban-column {
    background: var(--color-bg-deep);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    border-bottom: 2px solid;
  }

  .column-todo .column-header {
    background: var(--color-bg-secondary);
    border-color: var(--color-text-muted);
  }

  .column-in-progress .column-header {
    background: var(--color-primary-glow);
    border-color: var(--color-primary);
  }

  .column-done .column-header {
    background: rgba(34, 197, 94, 0.1);
    border-color: #22c55e;
  }

  .column-title {
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .column-todo .column-title { color: var(--color-text-muted); }
  .column-in-progress .column-title { color: var(--color-primary); }
  .column-done .column-title { color: #22c55e; }

  .column-count {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    background: var(--color-bg);
    color: var(--color-text-secondary);
  }

  .column-cards {
    flex: 1;
    padding: var(--space-3);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    overflow-y: auto;
    max-height: 600px;
  }

  .empty-column {
    text-align: center;
    padding: var(--space-8) var(--space-4);
    color: var(--color-text-muted);
    font-size: 0.875rem;
    font-style: italic;
  }

  .task-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
  }

  .task-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 1px var(--color-primary-glow);
  }

  .task-card.expanded {
    border-color: var(--color-primary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .task-card.card-done {
    opacity: 0.7;
  }

  .task-card.card-done:hover,
  .task-card.card-done.expanded {
    opacity: 1;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
  }

  .task-key {
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--color-primary);
  }

  .priority-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .priority-high { background: #ef4444; }
  .priority-medium { background: #fbbf24; }
  .priority-low { background: var(--color-text-muted); }

  .task-title {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-text);
    margin-bottom: var(--space-2);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .issue-type {
    font-family: var(--font-mono);
    font-size: 0.625rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .assignee {
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    background: var(--color-bg-secondary);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .unassigned {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  /* Task Details (Expanded View) */
  .task-details {
    display: none;
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border);
  }

  .task-card.expanded .task-details {
    display: block;
  }

  .task-card.expanded .task-title {
    -webkit-line-clamp: unset;
    display: block;
  }

  .details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
  }

  .details-key {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-primary);
  }

  .jira-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .jira-link:hover {
    color: var(--color-primary);
  }

  .details-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 var(--space-3) 0;
    line-height: 1.4;
  }

  .details-description {
    margin-bottom: var(--space-4);
  }

  .details-label {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-2);
  }

  .details-description p {
    font-size: 0.8125rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
    margin: 0;
    white-space: pre-wrap;
  }

  .details-meta {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .meta-label {
    font-family: var(--font-mono);
    font-size: 0.5625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
  }

  .meta-value {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .status-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.6875rem;
  }

  .status-todo {
    background: var(--color-bg-secondary);
    color: var(--color-text-muted);
  }

  .status-in-progress {
    background: var(--color-primary-glow);
    color: var(--color-primary);
  }

  .status-done {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
  }

  .priority-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.6875rem;
  }

  .priority-badge.priority-high {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
  }

  .priority-badge.priority-medium {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
  }

  .priority-badge.priority-low {
    background: var(--color-bg-secondary);
    color: var(--color-text-muted);
  }

  /* Responsive */
  @media (max-width: 900px) {
    .kanban-columns {
      grid-template-columns: 1fr;
      gap: var(--space-6);
    }

    .kanban-column {
      max-height: none;
    }

    .column-cards {
      max-height: 400px;
    }

    .details-meta {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Toggle task card expansion
  document.querySelectorAll('.task-card').forEach(card => {
    card.addEventListener('click', (e) => {
      // Don't toggle if clicking on a link
      if ((e.target as HTMLElement).closest('a')) {
        return;
      }

      // Close other expanded cards
      document.querySelectorAll('.task-card.expanded').forEach(other => {
        if (other !== card) {
          other.classList.remove('expanded');
        }
      });

      // Toggle this card
      card.classList.toggle('expanded');
    });
  });

  // Close expanded card when clicking outside
  document.addEventListener('click', (e) => {
    if (!(e.target as HTMLElement).closest('.task-card')) {
      document.querySelectorAll('.task-card.expanded').forEach(card => {
        card.classList.remove('expanded');
      });
    }
  });
</script>
