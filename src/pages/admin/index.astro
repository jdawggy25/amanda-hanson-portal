---
/**
 * Admin Dashboard
 *
 * Supabase Auth protected admin interface for managing SEO metrics
 * and generating reports.
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import AdminLayout from '../../layouts/AdminLayout.astro';
import clientsConfig from '../../../clients.config.json';
import { checkAuth } from '../../lib/auth/supabase-auth';

// Check for Supabase auth session
const auth = await checkAuth(Astro.cookies);
const isAuthenticated = auth.authenticated && auth.authorized;

// Check for error from URL (e.g., unauthorized email)
const errorParam = Astro.url.searchParams.get('error');
let loginError: string | null = null;
if (errorParam === 'unauthorized') {
  loginError = 'Your email is not authorized to access the admin area.';
}

// Get enabled clients
const clients = clientsConfig.clients.filter(c => c.enabled);

// Get current month for display
const now = new Date();
const monthDisplay = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
---

{!isAuthenticated ? (
  <BaseLayout title="Admin Login">
    <main class="admin-container">
      <!-- Login Form -->
      <div class="login-card">
        <div class="login-header">
          <div class="lock-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>
          <h1>Admin Access</h1>
          <p>Sign in with your admin account</p>
        </div>
        {loginError && (
          <div class="login-error">
            {loginError}
          </div>
        )}
        <div id="loginError" class="login-error" style="display: none;"></div>
        <form id="loginForm" class="login-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              placeholder="admin@example.com"
            />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="Enter your password"
            />
          </div>
          <button type="submit" class="btn-primary" id="loginBtn">
            Sign In
          </button>
        </form>
      </div>
    </main>
    <script>
      const form = document.getElementById('loginForm') as HTMLFormElement;
      const errorDiv = document.getElementById('loginError') as HTMLDivElement;
      const loginBtn = document.getElementById('loginBtn') as HTMLButtonElement;

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        errorDiv.style.display = 'none';
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';

        const formData = new FormData(form);

        try {
          const response = await fetch('/admin/api/auth/login', {
            method: 'POST',
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            window.location.href = '/admin';
          } else {
            errorDiv.textContent = data.error || 'Login failed';
            errorDiv.style.display = 'block';
          }
        } catch (error) {
          errorDiv.textContent = 'An unexpected error occurred';
          errorDiv.style.display = 'block';
          console.error('Login error:', error);
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
        }
      });
    </script>
  </BaseLayout>
) : (
  <AdminLayout title="Admin Dashboard" requireAuth={false}>
    <!-- Admin Dashboard -->
    <div class="dashboard">
        <header class="dashboard-header">
          <div>
            <h1>SEO Report Dashboard</h1>
            <p class="subtitle">Manage SEO metrics and generate monthly reports</p>
          </div>
          <div class="header-actions">
            <span class="current-month">{monthDisplay}</span>
          </div>
        </header>

        <!-- Quick Actions -->
        <section class="actions-section">
          <h2>Quick Actions</h2>
          <div class="action-buttons">
            <button id="collectMetrics" class="btn-action">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 0 1 9-9"></path>
              </svg>
              Collect Metrics
            </button>
            <button id="generateReports" class="btn-action btn-success">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Generate All Reports
            </button>
          </div>
        </section>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message hidden"></div>

        <!-- Client List -->
        <section class="clients-section">
          <h2>Clients ({clients.length})</h2>
          <div class="clients-grid">
            {clients.map((client) => (
              <div class="client-card" data-client-id={client.id}>
                <div class="client-header">
                  <h3>{client.name}</h3>
                </div>
                <div class="client-meta">
                  <span class="website">{client.website}</span>
                  {client.seoMetrics && (
                    <div class="metrics-snapshot">
                      <span class="metric">
                        <strong>DR:</strong> {client.seoMetrics.domainRating}
                      </span>
                      <span class="metric">
                        <strong>Keywords:</strong> {client.seoMetrics.organicKeywords}
                      </span>
                      <span class="metric">
                        <strong>Traffic:</strong> {client.seoMetrics.organicTraffic}
                      </span>
                    </div>
                  )}
                </div>
                <div class="client-actions">
                  <a href={`/${client.id}`} class="btn-secondary btn-small" target="_blank">
                    View Report
                  </a>
                  <button class="btn-icon generate-single" data-client={client.id} title="Generate Report">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 6 2 18 2 18 9"></polyline>
                      <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                      <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                  </button>
                </div>
              </div>
            ))}
          </div>
        </section>

    </div>
  </AdminLayout>
)}

<style>
  .admin-container {
    width: 100%;
    padding: 2rem 3rem;
    min-height: calc(100vh - 200px);
  }

  /* Login Styles */
  .login-card {
    max-width: 400px;
    margin: 4rem auto;
    background: rgba(20, 20, 20, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 2rem;
  }

  .login-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .lock-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .login-header h1 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: white;
  }

  .login-header p {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
  }

  .login-form .form-group {
    margin-bottom: 1.5rem;
  }

  .login-form label {
    display: block;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
  }

  .login-form input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
    font-size: 1rem;
  }

  .login-form input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
  }

  .login-error {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    color: #ef4444;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }

  /* Dashboard Styles */
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .dashboard-header h1 {
    font-size: 1.75rem;
    color: white;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    color: rgba(255, 255, 255, 0.6);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .current-month {
    background: rgba(102, 126, 234, 0.2);
    color: #667eea;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .logout-form {
    display: inline;
  }

  /* Actions Section */
  .actions-section {
    margin-bottom: 2rem;
  }

  .actions-section h2,
  .clients-section h2,
  .month-section h2 {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  .action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  /* Buttons */
  .btn-primary {
    width: 100%;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: white;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  .btn-small {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
  }

  .btn-action {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-action:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-1px);
  }

  .btn-action.btn-success {
    background: rgba(16, 185, 129, 0.2);
    border-color: rgba(16, 185, 129, 0.4);
    color: #10b981;
  }

  .btn-action.btn-success:hover {
    background: rgba(16, 185, 129, 0.3);
  }

  .btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-icon:hover {
    background: rgba(255, 255, 255, 0.15);
    color: white;
  }

  /* Status Message */
  .status-message {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .status-message.hidden {
    display: none;
  }

  .status-message.success {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid rgba(16, 185, 129, 0.4);
    color: #10b981;
  }

  .status-message.error {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    color: #ef4444;
  }

  .status-message.info {
    background: rgba(102, 126, 234, 0.2);
    border: 1px solid rgba(102, 126, 234, 0.4);
    color: #667eea;
  }

  /* Clients Grid */
  .clients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
  }

  .client-card {
    background: rgba(20, 20, 20, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 1.25rem;
    transition: border-color 0.2s;
  }

  .client-card:hover {
    border-color: rgba(255, 255, 255, 0.2);
  }

  .client-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
  }

  .client-header h3 {
    font-size: 1.1rem;
    color: white;
    margin: 0;
  }

  .client-meta {
    margin-bottom: 1rem;
  }

  .website {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .metrics-snapshot {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }

  .metric {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .metric strong {
    color: rgba(255, 255, 255, 0.5);
    font-weight: 500;
  }

  .client-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  @media (max-width: 768px) {
    .dashboard-header {
      flex-direction: column;
      gap: 1rem;
    }

    .header-actions {
      width: 100%;
      justify-content: space-between;
    }

    .clients-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Collect metrics button
  document.getElementById('collectMetrics')?.addEventListener('click', async () => {
    showStatus('info', 'Collecting metrics from Ahrefs API... This may take a few minutes.');

    try {
      const response = await fetch('/admin/api/collect-metrics', { method: 'POST' });
      const data = await response.json();

      if (data.success) {
        showStatus('success', `Metrics collected for ${data.clientsUpdated} clients.`);
      } else {
        showStatus('error', `Error: ${data.error}`);
      }
    } catch (error) {
      showStatus('error', 'Failed to collect metrics. Check console for details.');
      console.error(error);
    }
  });

  // Generate reports button
  document.getElementById('generateReports')?.addEventListener('click', async () => {
    showStatus('info', 'Generating reports...');

    try {
      const response = await fetch('/admin/api/generate-reports', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await response.json();

      if (data.success) {
        showStatus('success', `Generated ${data.reportsGenerated} reports.`);
      } else {
        showStatus('error', `Error: ${data.error}`);
      }
    } catch (error) {
      showStatus('error', 'Failed to generate reports. Check console for details.');
      console.error(error);
    }
  });

  // Single client generate buttons
  document.querySelectorAll('.generate-single').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const clientId = (e.currentTarget as HTMLElement).getAttribute('data-client');

      showStatus('info', `Generating report for ${clientId}...`);

      try {
        const response = await fetch('/admin/api/generate-reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientId })
        });
        const data = await response.json();

        if (data.success) {
          showStatus('success', `Report generated for ${clientId}.`);
        } else {
          showStatus('error', `Error: ${data.error}`);
        }
      } catch (error) {
        showStatus('error', 'Failed to generate report.');
        console.error(error);
      }
    });
  });

  function showStatus(type: 'success' | 'error' | 'info', message: string) {
    const el = document.getElementById('statusMessage');
    if (el) {
      el.className = `status-message ${type}`;
      el.textContent = message;
    }
  }
</script>
